name: Deploy Vite React App to Lightsail

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        echo "${{ secrets.EC2_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Deploy to Lightsail
      run: |
        RETRIES=5
        for i in $(seq 1 $RETRIES); do
          echo "üîÅ SSH attempt $i..."
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "[GITHUB-ACTIONS] ‚úÖ Connected to server"
            cd ~/saehaniam_2025_homepage/frontend
            echo "[GITHUB-ACTIONS] üìÅ Changed directory"
            git pull origin main || { echo "‚ùå Git pull failed"; exit 1; }
            echo "[GITHUB-ACTIONS] üì• Pulled latest"
            npm install
            echo "[GITHUB-ACTIONS] üì¶ npm install ÏôÑÎ£å"
            npm run build
            echo "[GITHUB-ACTIONS] üèó build ÏôÑÎ£å"
            sudo rm -rf /var/www/html/*
            sudo cp -r dist/* /var/www/html/
            echo "[GITHUB-ACTIONS] ‚úÖ ÌååÏùº Î≥µÏÇ¨ ÏôÑÎ£å"
            exit 0
        EOF
            if [ $? -eq 0 ]; then
              break
            else
              sleep 5
            fi
          done
